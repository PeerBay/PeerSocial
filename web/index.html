<!DOCTYPE html>
<!-- <html lang="en"> -->
<html lang="en" manifest="./assets/peerbay.appcache">

<head>
    <title>PeerFeed</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no" />
    <!-- <link rel='stylesheet' href='http://fonts.googleapis.com/css?family=Roboto:400,500,700,400italic'> -->
    <link rel="shortcut icon" type="image/x-icon" href="images/pbicon.ico">
    <link rel="stylesheet" href="./bower_components/angular-material/angular-material.css" />
    <link rel="stylesheet" href="./bower_components/angular-material-icons/angular-material-icons.css" />
    <link rel="stylesheet" href="./bower_components/lf-ng-md-fileinput/dist/lf-ng-md-file-input.css">
    <link rel="stylesheet" href="./bower_components/cropme/cropme.css">
    <link rel="stylesheet" href="./assets/app.css" />
</head>

<body ng-controller="AppCtrl" layout="row" ng-app="MyApp">
    <section ng-if="data.page=='signin'" flex layout="column" layout-align="center center">
        <md-content layout-padding>
            <md-card>
                <md-card-content>
                    <img src="images/logo.png" class="md-card-image" width=300 />
                    <md-input-container>
                        <label>Username</label>
                        <input ng-disabled="data.signingIn" name="username" ng-model="data.username" required minlength="4">
                    </md-input-container>
                    <md-input-container>
                        <label>Password</label>
                        <input ng-disabled="data.signingIn" name="password" type="password" ng-model="data.password" required minlength="4">
                    </md-input-container>
                    <md-input-container>
                        <md-button ng-disabled="data.signingIn" class="md-raised md-primary" ng-click="signIn($event)">Sign In
                        </md-button>
                        <md-button ng-click="data.signup=true;signIn($event);"> Sign Up
                        </md-button>
                    </md-input-container>
                    <md-input-container>
                        <md-checkbox ng-model="data.remember" aria-label="Remember Me">Remember Me</md-checkbox>
                    </md-input-container>
                    <md-progress-linear ng-if="data.signingIn" md-mode="indeterminate"></md-progress-linear>
                </md-card-content>
            </md-card>
        </md-content>
    </section>
    <section ng-if="data.page=='profileform'" flex layout="column" layout-align="center center" class="profileForm">
        <md-toolbar>
            <div flex class="md-toolbar-tools" layout-align="center center">
                <md-button class="md-warn" ng-click="data.page='feeds'">
                    <ng-md-icon icon="chevron_left"></ng-md-icon>
                    Home
                </md-button>
                <h1>Profile</h1>
            </div>
        </md-toolbar>
        <md-content class="basecolor" layout="row" layout-padding style="width:100%">
            <form flex="50" offset="25" ng-submit="createProfile();data.page='feeds'">
                <!--  <cropme width="667" height="300" ratio="0.4" icon-class="" type="png" destination-width="667" id="cropme1" ok-label="Ok"  cancel-label="Cancel" files="data.profile.files" property="coverImage" placeholder="Cover Image">
                </cropme> -->
                <md-input-container>
                    <label>Name</label>
                    <input name="name" ng-model="data.profile.name" required minlength="4">
                </md-input-container>
                <md-input-container>
                    <label>Handle (@)</label>
                    <input name="handle" ng-change="data.profile.handle=data.profile.handle.split(' ').join('').replace('@','')" ng-model="data.profile.handle" required minlength="4">
                </md-input-container>
                <md-input-container>
                    <label>Location</label>
                    <input name="location" ng-model="data.profile.location">
                </md-input-container>
                <md-input-container>
                    <label>Website</label>
                    <input type="url" name="website" ng-model="data.profile.website">
                </md-input-container>
                <md-input-container>
                    <label>Bio</label>
                    <textarea ng-model="data.profile.bio" columns="1" md-maxlength="120"></textarea>
                </md-input-container>
                <md-datepicker ng-model="data.profile.birthday" md-placeholder="Enter birthday"></md-datepicker>
                <cropme width="400" height="400" ratio="1" icon-class="" type="png" destination-width="200" id="cropme2" files="data.profile.files" property="profileImage" placeholder="Profile Image" ok-label="Ok" cancel-label="Cancel">
                </cropme>
                <!--           <lf-ng-md-file-input lf-files="data.profile.files" lf-property="profileImage" lf-placeholder="Pick Profile Picture" preview></lf-ng-md-file-input> -->
                <md-input-container>
                    <md-button class="md-raised md-primary" type="submit">Save</md-button>
                </md-input-container>
            </form>
        </md-content>
    </section>
    <section ng-if="data.page=='feeds'" flex layout="row">
        <md-content flex layout-padding layout="column" style="">
            <!-- layout="column" layout-fill layout-align="top center" -->
            <md-tabs md-selected="selectedIndex" md-border-bottom md-autoselect md-dynamic-height='true'>
                <md-tab md-on-select="walls[tab.wallid].start()" md-on-deselect="walls[tab.wallid].pause()" ng-repeat="tab in tabs" ng-disabled="tab.disabled">
                    <md-tab-label ng-class="{'md-raised':tab.type=='owner'}">
                        <ng-md-icon ng-if="tab.type=='owner'" icon="person_outline"></ng-md-icon>
                        <ng-md-icon ng-if="tab.type=='group'" icon="group"></ng-md-icon>
                        <span ng-if="tab.type=='hashtag'"><b>#</b></span>
                        <ng-md-icon ng-if="tab.type=='user'" icon="person"></ng-md-icon>
                        {{tab.handle || tab.data.name || tab.tag }}<sup style="color:red" ng-if="unread[tab.wallid].length">{{unread[tab.wallid].length}}</sup>
                        <ng-md-icon ng-if="tab.type!='owner'" icon="clear" ng-click="removeTab( tab )"></ng-md-icon>
                    </md-tab-label>
                    <md-tab-body style="">
                        <section layout="row" ng-if="tab.type=='user'||tab.type=='owner' " class="basecolor">
                            <md-content flex="20" layout="column" class="basecolor">
                                <md-toolbar>
                                    <div class="md-toolbar-tools">
                                        <!--         <img flex="100" ng-init="getFile(data.profile.coverImage)" ng-src="{{data.files[data.profile.coverImage]}}"> -->
                                        <h1 class="md-display-4">{{tab.name}}</h1>
                                    </div>
                                </md-toolbar>
                                <md-card flex=>
                                    <img ng-init="!data.files[tab.profileImage]?getFile(tab.profileImage):pass" ng-src="{{data.files[tab.profileImage]}}">
                                    <md-card-content>
                                        <h2 class="md-title">Bio</h2>
                                        <p>
                                            {{tab.bio}}
                                        </p>
                                    </md-card-content>
                                    <md-card>
                            </md-content>
                            <md-content flex="10" class="basecolor"></md-content>
                            <md-content flex class="md-padding basecolor">
                                <md-toolbar style="max-width:500px" flex class="md-tall " ng-init="tab.type=='user'?tab.publicPost.text='@'+tab.handle:pass ">
                                    <form ng-submit="submitPublicPost(tab)">
                                        <div class="md-toolbar-tools">
                                            <md-input-container>
                                                <md-autocomplete flex md-input-type="textarea" md-selected-item="tab.publicPost.selectedItem" md-search-text="tab.publicPost.text" md-items="item in queryPublicPost(tab.publicPost.text)" md-item-text="autocompletePublicPost(tab.publicPost.text,item.handle)" md-min-length="3" md-floating-label="{{tab.type=='owner'?'Share something':'Share with '+tab.name}}" md-menu-class="autocomplete-handles-template">
                                                    <md-item-template>
                                                        <span class="item-title">
                                            <ng-md-icon icon="perm_identity"></ng.-md-icon>
                                            <span> {{item.name}} </span>
                                                        </span>
                                                        <span class="item-metadata">
                                            <span class="item-metastat">
                                              Handle:<strong>{{item.handle}}</strong> 
                                            </span>
                                                        <span class="item-metastat">
                                              Location:<strong>{{item.location}}</strong> 
                                            </span>
                                                        </span>
                                                    </md-item-template>
                                                </md-autocomplete>
                                            </md-input-container>
                                        </div>
                                        <br>
                                        <div class="md-toolbar-tools md-toolbar-tools-bottom md-accent" layout="row" layout-sm="column" layout-align="space-between end">
                                            <md-input-container>
                                                <lf-ng-md-file-input lf-files="tab.publicPost.files" lf-on-file-removed="tab.resetPublicFiles" lf-property="images" multiple lf-placeholder="AddPhoto"></lf-ng-md-file-input>
                                            </md-input-container>
                                            <md-input-container>
                                                <md-button class="md-accent">Post</md-button>
                                            </md-input-container>
                                        </div>
                                    </form>
                                </md-toolbar>
                                <md-card ng-if="post.date" ng-click="post.wantAnswers=true" style="max-width:500px;margin:1px;" class="post" ng-repeat="post in Tab[tab.wallid] | orderBy: '-date'">
                                    <md-card-content id="post{{post.date}}">
                                        <div layout="row">
                                            <img class="avatarImage" ng-init="!data.files[data.profiles[post.feedID].profileImage]?getFile(data.profiles[post.feedID].profileImage):pass" ng-src="{{data.files[data.profiles[post.feedID].profileImage]}}" alt="">
                                            <h3>
                                                {{data.profiles[post.feedID].name}}
                                                </h3>
                                        </div>
                                        <p>
                                            {{post.message}}
                                        </p>
                                    </md-card-content>
                                    <md-card-footer>
                                        <md-grid-list md-cols="{{post.images.length>1?2:1}}" md-gutter="1em" md-row-height="1:1">
                                            <md-grid-tile ng-init="getFile(image)" ng-click="showImageGallery(post.images)" ng-repeat="image in post.images">
                                                <md-progress-circular ng-if="!data.files[image]" class="md-hue-2" md-mode="indeterminate" md-diameter="20px"></md-progress-circular>
                                                <div ng-if="data.files[image]" ng-style="{'background-image':'url('+data.files[image]+')', 'background-size': 'cover', 'background-position': '50%','width':'100%','height':'100%'}">
                                                </div>
                                            </md-grid-tile>
                                        </md-grid-list>
                                    </md-card-footer>
                                    <div class="md-actions" layout="row" layout-align="end center">
                                        <ng-md-icon icon="star"></ng-md-icon>
                                        <ng-md-icon icon="share"></ng-md-icon>
                                        <ng-md-icon icon="reply" ng-click="post.answer=true"></ng-md-icon>
                                    </div>
                                    <div class="answerPost md-accent md-hue-1" ng-if="post.answer" layout-padding layout="row">
                                        <img class="avatarImage" ng-src="{{data.files[data.profile.profileImage]}}" alt="">
                                        <md-autocomplete ng-init="post.publicPost.text='@'+data.profiles[post.feedID].handle" flex md-input-type="textarea" md-selected-item="post.publicPost.selectedItem" md-search-text="post.publicPost.text" md-items="item in queryPublicPost(post.publicPost.text)" md-item-text="autocompletePublicPost(post.publicPost.text,item.handle)" md-min-length="3" md-floating-label="Answer to {{data.profiles[post.feedID].name}}.." md-menu-class="autocomplete-handles-template">
                                            <md-item-template>
                                                <span class="item-title">
                                            <ng-md-icon icon="perm_identity"></ng-md-icon>
                                            <span> {{item.name}} </span>
                                                </span>
                                                <span class="item-metadata">
                                            <span class="item-metastat">
                                              Handle:<strong>{{item.handle}}</strong> 
                                            </span>
                                                <span class="item-metastat">
                                              Location:<strong>{{item.location}}</strong> 
                                            </span>
                                                </span>
                                            </md-item-template>
                                        </md-autocomplete>
                                        <md-button ng-click="submitPublicPost(post);">
                                            <ng-md-icon icon="send"></ng-md-icon>
                                        </md-button>
                                    </div>
                                    <div ng-if="post.wantAnswers" ng-init="getAnswerList(post)">
                                        <md-list>
                                            <md-subheader class="md-no-sticky">Answers</md-subheader>
                                            <md-divider></md-divider>
                                            <md-list-item class="md-3-line" ng-repeat="answer in post.answers | orderBy:'date'">
                                                <img class="avatarImage" ng-init="data.profiles[answer.feedID]?pass:getProfile(answer.feedID)" ng-src="{{data.files[data.profiles[answer.feedID].profileImage]}}" alt="">
                                                <div class="md-list-item-text" layout="column">
                                                    <b>{{data.profiles[answer.feedID].handle}}</b>
                                                    <p>{{ answer.message }}</p>
                                                </div>
                                            </md-list-item>
                                        </md-list>
                                        <md-input-container>
                                            <md-button class=" md-primary" ng-click="getAnswers(post)">{{post.answerlist.length}} answers..</md-button>
                                        </md-input-container>
                                    </div>
                                    </md-list-item>
                                    </md-list>
                                    </div>
                                    <div>
                                        <md-divider></md-divider>
                                    </div>
                                </md-card>
                                <br/>
                                <md-button class="md-raised md-primary loadmore" ng-click="walls[tab.wallid].loadmore()">Load More..</md-button>
                            </md-content>
                        </section>
                        <section ng-if="tab.type=='group' " layout="row">
                            <md-content flex="20" layout="column">
                                <md-list>
                                    <md-subheader class="md-no-sticky">{{tab.data.name}} users</md-subheader>
                                    <md-list-item class="md-3-line" ng-repeat="user in tab.data.users">
                                        <img ng-src="{{data.files[data.profiles[user].profileImage]}}" class="md-avatar" />
                                        <div class="md-list-item-text" layout="column">
                                            <h3>{{data.profiles[user].name}}</h3>
                                            <h4>@{{data.profiles[user].handle}}</h4>
                                        </div>
                                    </md-list-item>
                                    <md-divider></md-divider>
                                </md-list>
                                <md-autocomplete ng-if="tab.admin" md-items="item in queryHandles(data.groupForm.searchUserText)" md-item-text="item.name" placeholder="Add user" md-selected-item-change="feed.inviteToGroup(item.id,tab)" md-search-text="data.groupForm.searchUserText">
                                    <span md-highlight-text="data.groupForm.searchUserText">{{item.name}} :: {{item.handle}}</span>
                                </md-autocomplete>
                            </md-content>
                            <md-content offset="10" flex class="md-padding basecolor">
                                <md-toolbar style="max-width:500px" id="grouppostbox" flex class="md-tall ">
                                    <div class="md-toolbar-tools">
                                        <md-autocomplete flex md-input-type="textarea" md-selected-item="tab.groupPost.selectedItem" md-search-text="tab.groupPost.text" md-items="item in queryGroupPost(tab.groupPost.text)" md-item-text="autocompletePublicPost(tab.groupPost.text,item.handle)" md-min-length="3" md-floating-label="Post on {{tab.data.name}}" md-menu-class="autocomplete-handles-template">
                                            <md-item-template>
                                                <span class="item-title">
                                            <ng-md-icon icon="perm_identity"></ng-md-icon>
                                            <span> {{item.name}} </span>
                                                </span>
                                                <span class="item-metadata">
                                            <span class="item-metastat">
                                              Handle:<strong>{{item.handle}}</strong> 
                                            </span>
                                                <span class="item-metastat">
                                              Location:<strong>{{item.location}}</strong> 
                                            </span>
                                                </span>
                                            </md-item-template>
                                        </md-autocomplete>
                                    </div>
                                    <br>
                                    <div class="md-toolbar-tools md-toolbar-tools-bottom md-accent" layout="row" layout-sm="column" layout-align="space-between end">
                                        <md-input-container>
                                            <lf-ng-md-file-input lf-files="tab.groupPost.files" lf-on-file-removed="tab.resetGroupFiles" lf-property="images" multiple lf-placeholder="AddPhoto"></lf-ng-md-file-input>
                                        </md-input-container>
                                        <md-input-container>
                                            <md-button class="md-accent" ng-click="submitGroupPost(tab)">Post</md-button>
                                        </md-input-container>
                                    </div>
                                </md-toolbar>
                                <md-card ng-if="post.date" style="max-width:500px" ng-repeat="post in Tab[tab.wallid] | orderBy: '-date'">
                                    <md-card-content id="post{{post.date}}">
                                        <div layout="row">
                                            <img class="avatarImage" ng-src="{{data.files[data.profiles[post.user].profileImage]}}" alt="">
                                            <h3>
                                    {{data.profiles[post.user].name}}
                                    </h3>
                                        </div>
                                        <p>
                                            {{post.message}}
                                        </p>
                                    </md-card-content>
                                    <md-card-footer>
                                        <md-grid-list md-cols="{{post.images.length>1?2:1}}" md-gutter="1em" md-row-height="1:1">
                                            <md-grid-tile ng-init="getFile(image)" ng-click="showImageGallery(post.images)" ng-repeat="image in post.images">
                                                <md-progress-circular ng-hide="data.files[image]" class="md-hue-2" md-mode="indeterminate" md-diameter="20px"></md-progress-circular>
                                                <div ng-if="data.files[image]" ng-style="{'background-image':'url('+data.files[image]+')', 'background-size': 'cover', 'background-position': '50%','width':'100%','height':'100%'}">
                                                </div>
                                            </md-grid-tile>
                                        </md-grid-list>
                                    </md-card-footer>
                                    <div class="md-actions" layout="row" layout-align="end center">
                                        <ng-md-icon icon="star"></ng-md-icon>
                                        <ng-md-icon icon="share"></ng-md-icon>
                                        <ng-md-icon icon="reply" ng-click="post.answer=true"></ng-md-icon>
                                    </div>
                                </md-card>
                                <md-button class="md-raised md-primary loadmore" ng-click="walls[tab.wallid].loadmore()">Load More..</md-button>
                            </md-content>
                        </section>
                        <section ng-if="tab.type=='hashtag' ">
                            <md-content flex offset="30" class="md-padding" class="basecolor">
                                <md-card style="max-width:500px" ng-repeat="post in Tab[tab.wallid] | orderBy: '-date'">
                                    <md-card-content id="post{{post.date}}">
                                        <div layout="row">
                                            <img class="avatarImage" ng-src="{{data.files[data.profiles[post.user].profileImage]}}" alt="">
                                            <h3>
                                    {{data.profiles[post.user].name}}
                                    </h3>
                                        </div>
                                        <p>
                                            {{post.message}}
                                        </p>
                                    </md-card-content>
                                    <md-card-footer>
                                        <md-grid-list md-cols="{{post.images.length>1?2:1}}" md-gutter="1em" md-row-height="1:1">
                                            <md-grid-tile ng-init="getFile(image)" ng-click="showImageGallery(post.images)" ng-repeat="image in post.images">
                                                <md-progress-circular ng-hide="data.files[image]" class="md-hue-2" md-mode="indeterminate" md-diameter="20px"></md-progress-circular>
                                                <div ng-if="data.files[image]" ng-style="{'background-image':'url('+data.files[image]+')', 'background-size': 'cover', 'background-position': '50%','width':'100%','height':'100%'}">
                                                </div>
                                            </md-grid-tile>
                                        </md-grid-list>
                                    </md-card-footer>
                                    <div class="md-actions" layout="row" layout-align="end center">
                                        <ng-md-icon icon="star"></ng-md-icon>
                                        <ng-md-icon icon="share"></ng-md-icon>
                                        <ng-md-icon icon="reply" ng-click="post.answer=true"></ng-md-icon>
                                    </div>
                                </md-card>
                                <md-button class="md-raised md-primary loadmore" ng-click="walls[tab.wallid].loadmore()">Load More..</md-button>
                            </md-content>
                        </section>
                        <br/>
                    </md-tab-body>
                    <!--  <div class="demo-tab tab{{$index%4}}" style="padding: 25px; text-align: center;">
                    </div>
 -->
                </md-tab>
            </md-tabs>
        </md-content>
        <md-sidenav class="md-sidenav-right md-whiteframe-z2" md-component-id="right" md-is-locked-open="true">
            <md-toolbar class="md-theme-indigo md-tall">
                <div class="md-toolbar-tools">
                    <div layout="row" layout-sm="column">
                        <md-input-container style="margin-right: 10px;">
                            <label>Type</label>
                            <md-select ng-model="form.type">
                                <md-option ng-repeat="type in types" value="{{type}}">
                                    <ng-md-icon ng-if="type=='Group'" icon="group"></ng-md-icon>
                                    <ng-md-icon ng-if="type=='HashTag'" icon="whatshot"></ng-md-icon>
                                    <ng-md-icon ng-if="type=='User'" icon="person"></ng-md-icon>
                                    {{type}}
                                </md-option>
                            </md-select>
                        </md-input-container>
                        <md-autocomplete style="margin:auto;" ng-if="form.type=='User'" ng-change="data.searchText=data.searchText.replace(' ','').replace('@','').replace('#','')" md-selected-item="data.searchselectedItem" md-selected-item-change="form.query=item" md-search-text="data.searchText" md-items="item in queryHandles(data.searchText)" md-item-text="item.handle" md-min-length="3" placeholder="Search a user's handle" md-menu-class="autocomplete-handles-template">
                            <md-item-template>
                                <span class="item-title">
                                    <ng-md-icon icon="perm_identity"></ng-md-icon>
                                    <span> {{item.name}} </span>
                                </span>
                                <span class="item-metadata">
                                    <span class="item-metastat">
                                      Handle:<strong>{{item.handle}}</strong> 
                                    </span>
                                <span class="item-metastat">
                                      Location:<strong>{{item.location}}</strong> 
                                    </span>
                                </span>
                            </md-item-template>
                        </md-autocomplete>
                        <md-autocomplete style="margin:auto;" ng-if="form.type=='HashTag'" md-selected-item="data.searchselectedItem" md-selected-item-change="form.query=item" md-search-text="data.searchText" md-items="item in queryTags(data.searchText)" md-item-text="item.tag" md-min-length="2" placeholder="Search a HashTag" md-menu-class="autocomplete-handles-template">
                            <md-item-template>
                                <span class="item-title">
                                    <b>#</b>
                                    <span> {{item.tag}} </span>
                                </span>
                                <span class="item-metadata">
                                    <span class="item-metastat">
                                      Count:<strong>{{item.count}}</strong> 
                                    </span>
                                </span>
                            </md-item-template>
                        </md-autocomplete>
                        <md-input-container ng-if="form.type=='HashTag'">
                            <label for="content">{{form.type?form.type:'Choose type' }}</label>
                            <input ng-disabled="!form.type" type="text" id="content" ng-model="form.query">
                        </md-input-container>
                        <md-input-container ng-if="form.type=='Group'">
                            <label>Group Name</label>
                            <input name="name" ng-model="form.query" required minlength="4">
                        </md-input-container>
                    </div>
                </div>
                <md-button class="md-toolbar-tools md-toolbar-tools-bottom" class="add-tab md-primary md-raised" ng-disabled="!form.type || !form.query" ng-click="addTab()" style="margin-right: 0;">{{form.type=='Group'?'Create':'Add' }}</md-button>
            </md-toolbar>
            <md-content layout-padding>
                <md-list flex>
                    <md-subheader class="md-no-sticky">Notifications</md-subheader>
                    <md-list-item ng-if="!note.deleted" layout="row" class="md-3-line" ng-repeat="note in data.notifications">
                        <img ng-src="{{data.files[data.profiles[note.from].profileImage]}}" class="md-avatar" alt="{{item.who}}" />
                        <div class="md-list-item-text" layout="column">
                            <b>{{note.data.type}} by @{{data.profiles[note.from].handle}}</b>
                            <small>{{note.data.name}}</small>
                        </div>
                        <div layout="column">
                            <md-button class="" ng-click="feed.acceptGroupInvitation(note);note.deleted=true">
                                <ng-md-icon icon="check"></ng-md-icon>
                            </md-button>
                            <md-button ng-click="feed.deleteRequest(note);note.deleted=true">
                                <ng-md-icon icon="clear"></ng-md-icon>
                            </md-button>
                        </div>
                    </md-list-item>
                    <md-divider></md-divider>
                </md-list>
                <md-list flex>
                    <md-subheader class="md-no-sticky">History</md-subheader>
                    <md-list-item class="md-3-line" layout="row" ng-repeat="item in history">
                        <div class="md-list-item-text">
                            <ng-md-icon ng-if="item.type=='group'" icon="group"></ng-md-icon>
                            <span ng-if="item.type=='hashtag'"><b>#</b></span>
                            <ng-md-icon ng-if="item.type=='user'" icon="person"></ng-md-icon>
                            {{item.handle || item.data.name || item.tag }}
                        </div>
                    </md-list-item>
                </md-list>
            </md-content>
            <md-button style="bottom:0" ng-click="logout()">Log out</md-button>
        </md-sidenav>
    </section>
    <!-- 

        <md-content>
        <md-tabs md-selected="selectedIndex">
            <md-tab ng-repeat="wall in walls" md-on-select="onWallSelected(wall)" md-on-deselect="announceDeselected(wall)" ng-disabled="wall.disabled">
                <md-tab-label >
                <img ng-if="wall.type=='owner'" src="images/pb.png"></img>
                <ng-md-icon ng-if="wall.type=='privategroup'" icon="group"></ng-md-icon>
                <ng-md-icon ng-if="wall.type=='hashtag'" icon="whatshot"></ng-md-icon>
                <ng-md-icon ng-if="wall.type=='user'" icon="person"></ng-md-icon>
                    {{wall.title}}
                    <ng-md-icon icon="highlight_remove" ng-click="removeWall(wall)"></ng-md-icon>
                </md-tab-label>
                <md-tab-body>
                    {{wall.content}}
                </md-tab-body>
            </md-tab>
            <md-button> <ng-md-icon icon="my_library_add" ></ng-md-icon></md-button>
        </md-tabs>
        </md-content>
    -->
    <script src="./bower_components/angular/angular.js"></script>
    <script src="./bower_components/angular-sanitize/angular-sanitize.js"></script>
    <script src="./bower_components/angular-animate/angular-animate.js"></script>
    <script src="./bower_components/angular-aria/angular-aria.js"></script>
    <script src="./bower_components/angular-material/angular-material.js"></script>
    <script src="./bower_components/angular-material-icons/angular-material-icons.js"></script>
    <script src="./bower_components/moment/moment.js"></script>
    <script src="./bower_components/lf-ng-md-fileinput/dist/lf-ng-md-file-input.js"></script>
    <script src="./bower_components/angular-touch/angular-touch.js"></script>
    <script src="./bower_components/angular-superswipe/superswipe.js"></script>
    <script src="./bower_components/cropme/cropme.js"></script>
    <script src="./bower_components/autobahnjs/autobahn.js"></script>
    <script src="./bower_components/blob-util/dist/blob-util.js"></script>
    <script src="./bower_components/tweetnacl/nacl.js"></script>
    <script src="modules/idb.filesystem.js"></script>
    <script src="modules/crypto/nacl-stream.js"></script>
    <script src="modules/crypto/blake2s.js"></script>
    <script src="modules/crypto/scrypt.js"></script>
    <script src="modules/crypto/base58.js"></script>
    <script src="modules/autobahn.rtc.js"></script>
    <script src="modules/wamp.rtc.js"></script>
    <script src="modules/onion.rtc.js"></script>
    <script src="modules/peerbay.js"></script>
    <script src="modules/peerFeed.js"></script>
    <script type="text/javascript">
    (function() {
        'use strict';

        angular.module('MyApp', ['ngMaterial', 'ngMdIcons', 'lfNgMdFileInput', 'ngSanitize', 'cropme'])
            .config(function($mdThemingProvider, $mdIconProvider, $compileProvider) {
                $compileProvider.imgSrcSanitizationWhitelist(/^\s*(filesystem|data|blob):/);
                $mdIconProvider
                    .defaultIconSet("./assets/svg/avatars.svg", 128)
                    .icon("menu", "./assets/svg/menu.svg", 24)
                    .icon("share", "./assets/svg/share.svg", 24)
                    .icon("google_plus", "./assets/svg/google_plus.svg", 512)
                    .icon("hangouts", "./assets/svg/hangouts.svg", 512)
                    .icon("twitter", "./assets/svg/twitter.svg", 512)
                    .icon("plus", "./assets/svg/plus.svg", 512)
                    .icon("user", "./assets/svg/user.svg", 512)
                    .icon("group", "./assets/svg/group.svg", 512)
                    .icon("phone", "./assets/svg/phone.svg", 512);
                $mdThemingProvider.definePalette('peerBay', {
                    '50': 'E6E2E1',
                    '100': 'E4CDCA',
                    '200': 'BF4A4F',
                    '300': 'B52D35',
                    '400': 'A6131B',
                    '500': 'AF1C22',
                    '600': 'B01D24',
                    '700': 'A6141B',
                    '800': 'AF1E24',
                    '900': 'AF1E24',
                    'A100': 'E6E2E1',
                    'A200': 'E0A7A3',
                    'A400': '5E2A28',
                    'A700': '2C100C',
                    'contrastDefaultColor': 'light', // whether, by default, text (contrast)
                    // on this palette should be dark or light
                    'contrastDarkColors': ['50', '100', //hues which contrast should be 'dark' by default
                        '200', '300', '400', '500', '600', 'A100', 'A200'
                    ],
                    'contrastLightColors': '#E6E2E1' // could also specify this if default was 'dark'
                });
                $mdThemingProvider.theme('default')
                    .primaryPalette('peerBay')
                    .accentPalette('grey');


            }).filter('fromNow', function() {
                return function(dateString) {
                    return moment(dateString).fromNow()
                };
            }).controller('AppCtrl', function($scope, $mdToast, $mdDialog, $q) {
                $scope.types = ["User", "Group", "HashTag"]
                $scope.form = {}
                var tabs = [],
                    selected = null,
                    previous = null;
                $scope.tabs = tabs;
                $scope.getAnswerList = function(post) {
                    console.log("belongsTo", post)
                    $scope.feed.belongsTo(post._id).then(function(ansids) {
                        console.log(ansids)
                        post.answerlist = ansids
                        post.answers = []
                    })
                }
                $scope.getAnswers = function(post) {
                        var ansids = post.answerlist.splice(0, 3)

                        $scope.feed.get(ansids).then(function(ansdocs) {
                            console.log(post.answers)
                            ansdocs.forEach(function(ans, idx, all) {
                                var dateid = ans._id.split("-")
                                ans.date = dateid[1]
                                ans.feedID = dateid[0]
                                all[idx] = ans
                            })
                            post.answers = post.answers.concat(ansdocs)
                        })
                    }
                    // $scope.selectedIndex = 0;
                $scope.$watch('selectedIndex', function(current, old) {
                    previous = selected;
                    console.log($scope.tabs, current)
                    if ($scope.tabs[current]) $scope.walls[$scope.tabs[current].id].start()
                    selected = $scope.tabs[current];
                });
                $scope.logout = function() {
                    location.reload()
                    eraseCookie("peerbay")

                }


                $scope.addTab = function() {
                    console.log($scope.form.query)
                    switch ($scope.form.type) {
                        case "User":
                            var user = $scope.form.query.id
                            $scope.feed.addSettingValue("following", user)
                            $scope.feed.getProfile(user).then(function(profile) {
                                // console.log(profile)
                                $scope.data.profiles[user] = profile[0]
                                $scope.getFile(profile[0].profileImage)
                                $scope.data.profiles[user].type = "user"
                                $scope.data.profiles[user].wallid = $scope.Wall($scope.data.profiles[user])
                                    // $scope.$apply()

                                tabs.push($scope.data.profiles[user])
                            })
                            break;
                        case "Group":
                            $scope.feed.createPrivateGroup($scope.form.query).then(function(answer) {
                                console.log(answer)
                            })
                            break;
                        case "HashTag":
                            $scope.feed.addSettingValue("hashtags", $scope.form.query)


                            tabs.push({
                                "type": "hashtag",
                                "tag": $scope.form.query.tag,
                                "wallid": $scope.Wall({
                                    "type": "hashtag",
                                    "tag": $scope.form.query.tag
                                })
                            })
                            break;

                    }
                    $scope.form = {}
                };
                $scope.removeTab = function(tab) {
                    var index = tabs.indexOf(tab);
                    tabs.splice(index, 1);
                    switch (tab.type) {
                        case "hashtag":
                            $scope.feed.removeSettingValue("hashtags", tab.tag)
                            break;
                        case "user":
                            $scope.feed.removeSettingValue("following", tab._id)
                            break;
                        case "group":
                            $scope.feed.removeSettingValue("groups", tab.settingvalue)

                    }
                    $scope.history.push(tab)

                };
                $scope.Tab = {}
                $scope.history = []
                $scope.admin = {}
                $scope.walls = {}
                $scope.Wall = function(data) {
                    var wall = new Wall(data)
                    $scope.walls[wall.id] = wall
                    return wall.id
                }
                $scope.unread = {}
                var Wall = function(data) {
                    this.feed = data
                    console.log("wall:", data)
                    this.id = peerFeed.util.getRandomFilename()
                    $scope.Tab[this.id] = []
                    $scope.unread[this.id] = []
                    this.lastdate = 2000000000000000
                    return this
                }
                Wall.prototype = {
                        start: function() {
                            this.active = true

                            console.log("started wall", this.feed)
                            var self = this;

                            switch (this.feed.type) {
                                case "user":
                                case "owner":
                                    var self = this;
                                    if (this.started) {
                                        if ($scope.unread[this.id].length) {
                                            $scope.feed.get($scope.unread[this.id]).then(function(data) {
                                                console.log(data)
                                                data.forEach(function(doc, i, theDocs) {
                                                    doc.date = parseInt(doc._id.split("-")[1])
                                                    if (doc.date && self.lastdate > doc.date) self.lastdate = doc.date
                                                    doc.feedID = doc._id.split("-")[0]
                                                    theDocs[i] = doc;
                                                    $scope.Tab[self.id].push(doc)
                                                })
                                                $scope.unread[self.id] = []
                                                $scope.$apply()
                                                    // console.log(self.loadedPosts)

                                            })
                                        }
                                    } else {
                                        this.started = true
                                        $scope.feed.getFeedDocIds(this.feed._id).then(
                                            function(ans) {
                                                // self.index = self.index.concat(ans)
                                                //     // console.log(self.index)
                                                //     // console.log(ans)
                                                // self.index.sort(function(a, b) {
                                                //     return parseFloat(b.date) - parseFloat(a.date);
                                                // });
                                                console.log(ans)
                                                $scope.feed.get(ans).then(function(data) {

                                                        data.forEach(function(doc, i, theDocs) {
                                                                doc.date = parseInt(doc._id.split("-")[1])
                                                                if (doc.date && self.lastdate > doc.date) self.lastdate = doc.date
                                                                doc.feedID = doc._id.split("-")[0]
                                                                theDocs[i] = doc;
                                                                $scope.Tab[self.id].push(doc)
                                                                $scope.$apply()
                                                            })
                                                            // console.log(self.loadedPosts)

                                                    })
                                                    // console.log(self.index)
                                                    // self.getItemAtIndex(0)
                                            })
                                        console.log("following", this.feed)
                                        $scope.feed.follow(this.feed._id, function(data) {

                                            // $scope.$apply()
                                            // self.index = self.index.concat(data)
                                            // self.index.sort(function(a, b) {
                                            //     return parseFloat(b.date) - parseFloat(a.date);
                                            // });
                                            console.log(data)
                                            if (self.active) {
                                                $scope.feed.get(data).then(function(data) {
                                                    console.log(data)
                                                    data.forEach(function(doc, i, theDocs) {
                                                            doc.date = parseInt(doc._id.split("-")[1])
                                                            if (doc.date && self.lastdate > doc.date) self.lastdate = doc.date
                                                            doc.feedID = doc._id.split("-")[0]
                                                            theDocs[i] = doc;
                                                            $scope.Tab[self.id].push(doc)
                                                            $scope.$apply()
                                                        })
                                                        // console.log(self.loadedPosts)

                                                })
                                            } else {
                                                console.log()
                                                $scope.unread[self.id] = $scope.unread[self.id].concat(data)
                                                $scope.$apply()

                                            }
                                            // console.log(self.index)
                                        })



                                    }




                                    break;
                                case "group":
                                    console.log(this.feed)
                                    if (this.started) {
                                        if ($scope.unread[this.id].length) {
                                            $scope.feed.get($scope.unread[this.id]).then(function(data) {
                                                console.log(data)
                                                for (var i in data) {
                                                    var doc = data[i]
                                                    var feedID = doc._id.split("-")[0]
                                                    doc = $scope.feed.decryptDoc(doc, self.feed.secret)
                                                    var post = JSON.parse(doc.data.doc)
                                                    post.date = parseInt(doc._id.split("-")[1])
                                                    if (post.date && self.lastdate > post.date) self.lastdate = post.date
                                                    post.feedID = feedID
                                                    post.user = doc.data.key
                                                    post._id = doc._id
                                                    $scope.Tab[self.id].push(post)
                                                    console.log(post)

                                                }
                                                $scope.unread[self.id] = []
                                                $scope.$apply()
                                                    // console.log(self.loadedPosts)

                                            })
                                        }
                                    } else {
                                        this.started = true
                                        this.feed.data.users.forEach(function(user) {
                                            $scope.getProfile(user)
                                        })
                                        $scope.feed.getFeedDocIds(this.feed.feedID).then(
                                            function(ans) {
                                                // self.index = self.index.concat(ans)
                                                //     // console.log(self.index)
                                                //     // console.log(ans)
                                                // self.index.sort(function(a, b) {
                                                //     return parseFloat(b.date) - parseFloat(a.date);
                                                // });
                                                // console.log(self.index)
                                                // self.getItemAtIndex(0)
                                                $scope.feed.get(ans).then(function(data) {
                                                    console.log(data)
                                                    for (var i in data) {
                                                        var doc = data[i]
                                                        var feedID = doc._id.split("-")[0]
                                                        doc = $scope.feed.decryptDoc(doc, self.feed.secret)
                                                        var post = JSON.parse(doc.data.doc)
                                                        post.date = parseInt(doc._id.split("-")[1])
                                                        if (post.date && self.lastdate > post.date) self.lastdate = post.date
                                                        post.feedID = feedID
                                                        post.user = doc.data.key
                                                        post._id = doc._id
                                                        $scope.Tab[self.id].push(post)

                                                        console.log(post)

                                                    }

                                                    // console.log(self.loadedPosts)


                                                })
                                            })
                                        console.log("following", this.feed)
                                        $scope.feed.follow(this.feed.feedID, function(data) {
                                            console.log(data)
                                            if (self.active) {
                                                $scope.feed.get(data).then(function(data) {
                                                    console.log(data)
                                                    for (var i in data) {
                                                        var doc = data[i]
                                                        var feedID = doc._id.split("-")[0]
                                                        doc = $scope.feed.decryptDoc(doc, self.feed.secret)
                                                        var post = JSON.parse(doc.data.doc)
                                                        post.date = parseInt(doc._id.split("-")[1])
                                                        if (post.date && self.lastdate > post.date) self.lastdate = post.date
                                                        post.feedID = feedID
                                                        post.user = doc.data.key
                                                        post._id = doc._id
                                                        $scope.Tab[self.id].push(post)
                                                        console.log(post)
                                                        $scope.$apply()

                                                    }

                                                    // console.log(self.loadedPosts)


                                                })
                                            } else {
                                                $scope.unread[self.id] = $scope.unread[self.id].concat(data)
                                                $scope.$apply()
                                            }
                                        })
                                    }

                                case "hashtag":
                                    var self = this;
                                    if (this.started) {
                                        if ($scope.unread[this.id].length) {
                                            $scope.feed.get($scope.unread[this.id]).then(function(data) {
                                                console.log(data)
                                                data.forEach(function(doc, i, theDocs) {
                                                    doc.date = parseInt(doc._id.split("-")[1])
                                                    if (doc.date && self.lastdate > doc.date) self.lastdate = doc.date
                                                    doc.user = doc._id.split("-")[0]
                                                    $scope.getProfile(doc.user)
                                                    theDocs[i] = doc;
                                                    $scope.Tab[self.id].push(doc)
                                                })
                                                $scope.unread[self.id] = []
                                                $scope.$apply()
                                                    // console.log(self.loadedPosts)

                                            })
                                        }
                                    } else {
                                        this.started = true
                                        $scope.feed.getTagDocIds(this.feed.tag).then(
                                            function(ans) {
                                                // self.index = self.index.concat(ans)
                                                //     // console.log(self.index)
                                                //     // console.log(ans)
                                                // self.index.sort(function(a, b) {
                                                //     return parseFloat(b.date) - parseFloat(a.date);
                                                // });
                                                console.log(ans)
                                                $scope.feed.get(ans).then(function(data) {
                                                        data.forEach(function(doc, i, theDocs) {
                                                                doc.date = parseInt(doc._id.split("-")[1])
                                                                if (doc.date && self.lastdate > doc.date) self.lastdate = doc.date
                                                                doc.user = doc._id.split("-")[0]
                                                                $scope.getProfile(doc.user)
                                                                theDocs[i] = doc;
                                                                $scope.Tab[self.id].push(doc)
                                                                $scope.$apply()
                                                            })
                                                            // console.log(self.loadedPosts)

                                                    })
                                                    // console.log(self.index)
                                                    // self.getItemAtIndex(0)
                                            })
                                        $scope.feed.follow("tag-" + this.feed.tag, function(data) {

                                            // $scope.$apply()
                                            // self.index = self.index.concat(data)
                                            // self.index.sort(function(a, b) {
                                            //     return parseFloat(b.date) - parseFloat(a.date);
                                            // });
                                            console.log(data)
                                            if (self.active) {
                                                $scope.feed.get(data).then(function(data) {
                                                    console.log(data)
                                                    data.forEach(function(doc, i, theDocs) {
                                                            doc.date = parseInt(doc._id.split("-")[1])
                                                            if (doc.date && self.lastdate > doc.date) self.lastdate = doc.date
                                                            doc.user = doc._id.split("-")[0]
                                                            $scope.getProfile(doc.user)
                                                            theDocs[i] = doc;
                                                            $scope.Tab[self.id].push(doc)
                                                            $scope.$apply()
                                                        })
                                                        // console.log(self.loadedPosts)

                                                })
                                            } else {
                                                console.log()
                                                $scope.unread[self.id] = $scope.unread[self.id].concat(data)
                                                $scope.$apply()

                                            }
                                            // console.log(self.index)
                                        })



                                    }


                            }


                        },
                        stop: function() {

                        },
                        pause: function() {
                            console.log("paused")
                            this.active = false
                        },
                        loadmore: function() {
                            var self = this;

                            switch (this.feed.type) {
                                case "user":
                                case "owner":
                                    if (this.lastchecked != self.lastdate) {
                                        console.log(this.feed._id, this.lastdate)
                                        $scope.feed.getFeedDocIds(this.feed._id, this.lastdate).then(
                                            function(ans) {

                                                $scope.feed.get(ans).then(function(data) {
                                                    data.forEach(function(doc, i, theDocs) {
                                                        console.log(doc)
                                                        doc.date = parseInt(doc._id.split("-")[1])
                                                        self.lastchecked = self.lastdate
                                                        if (doc.date && self.lastdate >= doc.date) self.lastdate = doc.date
                                                        doc.feedID = doc._id.split("-")[0]
                                                        theDocs[i] = doc;
                                                        $scope.Tab[self.id].push(doc)
                                                        $scope.$apply()
                                                    })
                                                })
                                            })
                                    }
                                    break;
                                case "group":
                                    if (this.lastchecked != self.lastdate) {
                                        $scope.feed.getFeedDocIds(this.feed.feedID, this.lastdate).then(
                                            function(ans) {
                                                $scope.feed.get(ans).then(function(data) {
                                                    console.log(data)
                                                    for (var i in data) {
                                                        var doc = data[i]
                                                        var feedID = doc._id.split("-")[0]
                                                        self.lastchecked = self.lastdate
                                                        doc = $scope.feed.decryptDoc(doc, self.feed.secret)
                                                        var post = JSON.parse(doc.data.doc)
                                                        post.date = parseInt(doc._id.split("-")[1])
                                                        if (post.date && self.lastdate > post.date) self.lastdate = post.date
                                                        post.feedID = feedID
                                                        post.user = doc.data.key
                                                        post._id = doc._id
                                                        $scope.Tab[self.id].push(post)
                                                        console.log(post)

                                                    }

                                                })
                                            })
                                    }
                                    break;
                                case "hashtag":
                                 if (this.lastchecked != self.lastdate) {
                                    $scope.feed.getTagDocIds(this.feed.tag, this.lastdate).then(
                                        function(ans) {

                                            $scope.feed.get(ans).then(function(data) {
                                                data.forEach(function(doc, i, theDocs) {
                                                    doc.date = parseInt(doc._id.split("-")[1])
                                                    self.lastchecked = self.lastdate
                                                    if (doc.date && self.lastdate > doc.date) self.lastdate = doc.date
                                                    doc.user = doc._id.split("-")[0]
                                                    $scope.getProfile(doc.user)
                                                    theDocs[i] = doc;
                                                    $scope.Tab[self.id].push(doc)
                                                    $scope.$apply()
                                                })
                                            })
                                        })
                                }
                                    break;

                            }

                        }
                    }
                    // 4 types of walls
                    // private group
                    // public group
                    // hashtag 
                    // user

                var cookie = readCookie("peerbay")
                if (cookie) {
                    console.log(cookie)
                    cookie = cookie.split(",")
                    var cookieboxKeys = nacl.box.keyPair.fromSecretKey(nacl.util.decodeBase64(cookie[0]))
                    var cookiesignKeys = nacl.sign.keyPair.fromSecretKey(nacl.util.decodeBase64(cookie[1]))
                    startFeed(cookieboxKeys, cookiesignKeys)
                }
                $scope.signIn = function() {
                    $scope.data.signingIn = true
                    if(!$scope.data.password || !$scope.data.username){
                        $scope.showSimpleToast("Please enter username and password to sign up...")
                        return
                    }
                    peerFeed.crypto.getKeyPair($scope.data.password, $scope.data.username, function(boxKeys, signKeys) {
                        peerFeed.session.keys = boxKeys
                        peerFeed.session.signKeys = signKeys
                        peerFeed.session.keyPairReady = true
                            // Keep polling until we have a key pair
                        var keyReadyInterval = setInterval(function() {
                            if (peerFeed.session.keyPairReady) {
                                clearInterval(keyReadyInterval)
                                $mdToast.hide();

                                startFeed(boxKeys, signKeys)


                            }
                        }, 500)
                    })
                }

                function startFeed(boxKeys, signKeys) {
                    new Feed(boxKeys, signKeys).then(function(feed) {
                        $scope.data.connected = true
                        if ($scope.data.remember) {

                            createCookie("peerbay", [nacl.util.encodeBase64(boxKeys.secretKey), nacl.util.encodeBase64(signKeys.secretKey)], 2)
                        }
                        feed.getProfile().then(function(profile) {
                            $scope.feed = feed
                            $scope.signKey = feed.signKey
                            console.log(profile)
                            if (!profile[0]) {

                                console.log("new user")
                                if ($scope.data.signup) {
                                    $scope.data.page = "profileform"
                                } else {
                                    $scope.showSimpleToast("New user? Sign Up or try another username/password.")
                                    $scope.data.signingIn = false
                                    $scope.data.newAccount = true
                                    $scope.$apply()
                                }

                            } else {
                                $scope.feed.onlineUsers(function(usersnum) {
                                    $scope.data.onlineUsers = usersnum[0]
                                })
                                $scope.data.profile = profile[0]
                                $scope.data.profile.type = "owner"
                                $scope.data.profile.admin = $scope.signKey

                                $scope.data.profiles[$scope.data.profile._id] = $scope.data.profile

                                $scope.data.profile.wallid = $scope.Wall($scope.data.profile)
                                tabs.push($scope.data.profile)
                                $scope.feed.getSettings().then(function(settings) {
                                    // console.log("settings:", settings)
                                    $scope.data.settings = settings
                                    if (settings.groups) {
                                        $scope.feed.getGroupsInfo($scope.data.settings.groups.data).then(function(groups) {
                                            console.log(groups)
                                            groups.forEach(function(group, idx, all) {
                                                if (group.data.name) {
                                                    group.type = "group"
                                                    all[idx] = group

                                                    group.wallid = $scope.Wall(group)
                                                    tabs.push(group)

                                                }
                                            })
                                        })


                                    }
                                    if (settings.following) {
                                        settings.following.data.forEach(function(user, idx, all) {
                                            $scope.feed.getProfile(user).then(function(profile) {
                                                // console.log(profile)
                                                $scope.data.profiles[user] = profile[0]
                                                $scope.getFile(profile[0].profileImage)
                                                $scope.data.profiles[user].type = "user"
                                                $scope.data.profiles[user].wallid = $scope.Wall($scope.data.profiles[user])
                                                    // $scope.$apply()

                                                tabs.push($scope.data.profiles[user])
                                            })
                                        })


                                    }
                                    if (settings.hashtags) {
                                        settings.hashtags.data.forEach(function(tag, idx, all) {
                                            tabs.push({
                                                type: "hashtag",
                                                "tag": tag,
                                                "wallid": $scope.Wall({
                                                    type: "hashtag",
                                                    "tag": tag
                                                })
                                            })
                                        })
                                    } else {
                                        var wall = new Wall({
                                            type: "hashtag",
                                            "tag": "peerbay"
                                        })
                                        $scope.walls[wall.id] = wall
                                        tabs.push({
                                            type: "hashtag",
                                            "tag": "peerbay",
                                            "wallid": wall.id
                                        })
                                    }


                                })




                                $scope.feed.getNewRequests().then(function(requests) {
                                    console.log(requests)
                                    $scope.data.notifications = $scope.data.notifications.concat(requests)
                                })
                                $scope.feed.follow("requests-" + $scope.signKey, function(data) {
                                        $scope.feed.getNewRequests().then(function(requests) {
                                            console.log(requests)
                                            $scope.data.notifications = $scope.data.notifications.concat(requests)
                                            $scope.$apply()
                                        })


                                    })
                                    // $scope.feed.getFeed(feed.signKey).then(function(data) {
                                    //     console.log(data)
                                    //     $scope.data.publicWall = $scope.data.publicWall.concat(data)
                                    //         // $scope.$apply()
                                    // })
                                $scope.data.page = "feeds"


                            }

                            // feed.follow
                        })

                        $scope.$apply()
                    })

                }












                $scope.getGroupInfo = function() {
                    if ("groups" in $scope.data.settings) {
                        $scope.feed.getGroupsInfo($scope.data.settings.groups.data).then(function(groups) {
                            console.log(groups)
                            $scope.data.groups = groups
                        })
                    }
                }

                $scope.getFile = function(infohash) {

                    if ($scope.data.onprogressfiles.indexOf(infohash) == -1 && !$scope.data.files[infohash] && infohash) {
                        console.log("getting file:", infohash)
                        $scope.data.onprogressfiles.push(infohash)
                        var deferred = $q.defer();
                        $scope.feed.getFile(infohash).then(function(file) {
                            console.log("file loaded")
                            $scope.data.files[infohash] = file
                            $scope.$apply()
                        })
                        return deferred.promise

                    }
                }
                $scope.getNewsFeed = function() {
                    if ("news" in $scope.data.settings)
                        $scope.data.settings.news.data.forEach(function(rss) {

                            $scope.feed.getRssFeeds([rss]).then(function(articles) {
                                console.log(articles)
                                articles.forEach(function(article) {
                                    if ($scope.data.newsLinks.indexOf(article.link) == -1) {
                                        var parser = new DOMParser()
                                        var readyMainDoc = parser.parseFromString(article.summary, "text/html")
                                        article.summary = readyMainDoc.documentElement.textContent
                                        article.source = article.link.split("/")[2]
                                        $scope.data.news.push(article)
                                        $scope.data.newsLinks.push(article.link)
                                    }

                                })
                                $scope.$apply()

                            })

                        })
                }
                $scope.addRssFeed = function() {
                    if ($scope.data.newsForm.rsslink) {
                        $scope.feed.addSettingValue("news", $scope.data.newsForm.rsslink).then(function(da) {
                            console.log(da)

                        })
                        var link = $scope.data.newsForm.rsslink
                        $scope.feed.getRssFeeds([link]).then(function(articles) {
                            articles.forEach(function(article) {
                                if ($scope.data.newsLinks.indexOf(article.link) == -1) {
                                    var parser = new DOMParser()
                                    var readyMainDoc = parser.parseFromString(article.summary, "text/html")
                                    article.summary = readyMainDoc.documentElement.textContent
                                    $scope.data.news.push(article)
                                    console.log(article.date)
                                    $scope.data.newsLinks.push(article.link)
                                }

                            })

                        })
                        $scope.data.newsForm.rsslink = ""
                    }
                }
                $scope.getArticle = function(link) {


                    $mdDialog.show({

                        clickOutsideToClose: true,
                        scope: $scope, // use parent scope in template
                        preserveScope: true, // do not forget this if use parent scope
                        // Since GreetingController is instantiated with ControllerAs syntax
                        // AND we are passing the parent '$scope' to the dialog, we MUST
                        // use 'vm.<xxx>' in the template markup
                        template: '<md-dialog aria-label="Article"  style="max-width:50%">' +
                            '  <md-dialog-content>' +
                            '<md-card flex="50" >' +
                            '<img ng-if="data.files[data.newsPost.image]"  ng-src="{{data.files[data.newsPost.image]}}" class="md-card-image" alt="image caption">' +
                            '<md-card-content >' +
                            '<h2>{{data.newsPost.title}}</h2>' +
                            '<div style="white-space: pre-line;" ng-bind-html="data.newsPost.text"></div>' +
                            '</md-card-content>' +
                            '<md-card-footer>' +
                            '{{data.newsPost.canonicalLink}}' +
                            '</md-card-footer>' +
                            ' </md-card>' +
                            '  </md-dialog-content>' +
                            '</md-dialog>',

                        controller: function DialogController($scope, $mdDialog) {
                            if (!$scope.data.newsPosts[link]) {
                                $scope.data.newsPost = {}
                                $scope.feed.getArticle(link).then(function(article) {
                                    console.log(article)
                                    $scope.data.newsPosts[link] = article
                                    $scope.data.newsPost = article
                                    $scope.feed.getFile(article.image).then(function(img) {
                                            $scope.data.files[article.image] = img
                                            $scope.$apply()
                                        })
                                        // var parser = new DOMParser()
                                        // var readyMainDoc = parser.parseFromString(article.text, "text/html")
                                        // article.text = readyMainDoc.documentElement.textContent
                                        // els=readyMainDoc.querySelectorAll("*")
                                        // for (i in els){
                                        //     if(!els.item(i).textContent.replace(" ","")){

                                    //     }
                                    // }
                                    $scope.$apply()
                                    $scope.closeDialog = function() {
                                        $mdDialog.hide();
                                    }

                                });
                            } else {
                                $scope.data.newsPost = $scope.data.newsPosts[link]
                            }
                        }
                    })




                }
                $scope.showImageGallery = function(images) {


                    $mdDialog.show({

                        clickOutsideToClose: true,
                        scope: $scope, // use parent scope in template
                        preserveScope: true, // do not forget this if use parent scope
                        // Since GreetingController is instantiated with ControllerAs syntax
                        // AND we are passing the parent '$scope' to the dialog, we MUST
                        // use 'vm.<xxx>' in the template markup
                        template: '<md-dialog aria-label="Article"  style="max-width:50%">' +
                            '  <md-dialog-content>' +
                            '<md-card flex="70" >' +
                            '<md-card-content >' +
                            '<img style="width:100%" ng-if="data.files[image]"  ng-src="{{data.files[image]}}" class="md-card-image" alt="image caption">' +
                            '</md-card-content>' +
                            '<md-card-footer>' +
                            '<md-button ng-click="previousPic()">Previous</md-button>' +
                            '<md-button ng-click="nextPic()">Next</md-button>' +
                            '</md-card-footer>' +
                            ' </md-card>' +
                            '  </md-dialog-content>' +
                            '</md-dialog>',

                        controller: function DialogController($scope, $mdDialog) {
                            var numimg = images.length
                            var i = 0;
                            $scope.image = images[i];
                            $scope.previousPic = function() {
                                if (i == 0) i = numimg
                                i--;
                                $scope.image = images[i];
                            }
                            $scope.nextPic = function() {
                                i++;
                                if (i == (numimg)) i = 0
                                $scope.image = images[i];
                            }


                        }
                    })




                }
                $scope.showNotifications = function() {

                    $scope.notificationsBox = true
                    $mdDialog.show({
                        parent: angular.element(document.querySelector("#notify")),
                        clickOutsideToClose: true,
                        scope: $scope, // use parent scope in template
                        preserveScope: true, // do not forget this if use parent scope
                        // Since GreetingController is instantiated with ControllerAs syntax
                        // AND we are passing the parent '$scope' to the dialog, we MUST
                        // use 'vm.<xxx>' in the template markup
                        hasBackdrop: false,
                        template: '<md-dialog flex    >' +
                            '  <md-dialog-content style="padding:0px">' +
                            '  <div layout="row" layout-align="space-between start">' +
                            '  <ng-md-icon icon="close" ng-click="closeDialog()"></ng-md-icon>' +
                            '  <h4> Notifications</h4>' +
                            '  <ng-md-icon icon="clear_all" ng-click="data.notifications=[]"></ng-md-icon>' +
                            '  </div>' +
                            '<md-card style="height:100px" ng-init="getProfile(note.from)" layout="row" ng-repeat="note in data.notifications">' +
                            '<img flex="25" ng-init="getFile(data.profiles[note.from].profileImage)"  ng-src="{{data.files[data.profiles[note.from].profileImage]}}" class="md-card-image" alt="image caption">' +
                            '<md-card-content >' +
                            '<div layout="row">' +
                            '<div layout="column">' +
                            '<b>{{note.data.type}} by @{{data.profiles[note.from].handle}}</b>' +
                            '<div > {{note.data.name}}</div>' +
                            '<div > {{note.data.info}}</div>' +
                            '</div>' +
                            '<div layout="column">' +
                            '<md-button ng-click="feed.acceptGroupInvitation(note)"> Accept</md-button>' +
                            '<md-button ng-click=""> Reject</md-button>' +
                            '</div>' +
                            '</div>' +
                            '</md-card-content>' +
                            ' </md-card>' +
                            '  </md-dialog-content>' +
                            '</md-dialog>',

                        controller: function DialogController($scope, $mdDialog) {
                            var actionTypes = ["groupInvite"]
                            for (var note in $scope.data.notifications) {

                            }
                            $scope.closeDialog = function() {
                                $mdDialog.hide();
                            }

                        },
                        onRemoving: function() {

                            $scope.notificationsBox = false
                        }
                    })




                }
                $scope.data = {
                    selectedIndex: 0,
                    secondLocked: true,
                    secondLabel: "Item Two",
                    bottom: false,
                    connected: false,
                    signingIn: false,
                    groupForm: {},
                    page: "signin",
                    publicPost: {},
                    publicWall: null,
                    profiles: {},
                    subpage: "mywall",
                    mywallunread: 0,
                    search: {},
                    onprogressfiles: [],
                    files: {},
                    newsForm: {},
                    news: [],
                    newsPosts: {},
                    newsLinks: [],
                    newAccount: false,
                    signup: false,
                    notifications: []
                };
                $scope.toastPosition = {
                    bottom: true,
                    top: false,
                    left: false,
                    right: true
                };
                // $scope.torrentClient = new WebTorrent()
                $scope.createPrivateGroup = function() {
                    console.log($scope.data.groupForm)
                    $scope.feed.createPrivateGroup($scope.data.groupForm).then(function(answer) {
                        console.log(answer)
                    })
                }
                $scope.createProfile = function() {
                    console.log($scope.data.profile)
                    $scope.feed.createProfile($scope.data.profile).then(
                        function(ans) {
                            console.log(ans)
                            if (ans.ok) {
                                $scope.data.profile._id = ans.id
                                $scope.data.profile._rev = ans.rev
                                location.reload()
                            } else if (ans.error) {
                                $scope.showSimpleToast("Error:" + ans.error)
                            }
                        })
                }
                $scope.followFeed = function(feedID) {
                    if (feedID !== $scope.feed.signKey) {
                        if ("following" in $scope.feed.mySettings) {
                            if ($scope.feed.mySettings.following.data.indexOf(feedID) == -1) {
                                $scope.feed.addSettingValue("following", feedID).then(function(ans) {
                                    $scope.data.publicWall.addFeedID(feedID)

                                })

                            } else {
                                $scope.showSimpleToast("Info: Already following.")
                            }
                        } else {
                            $scope.feed.addSettingValue("following", feedID).then(function(ans) {
                                $scope.data.publicWall.addFeedID(feedID)

                            })
                        }
                    }
                }
                $scope.loadFeedWall = function(feedID) {
                    if (feedID) {
                        $scope.data.subpage = "feedwall"
                        $scope.data.feedwallid = feedID
                        $scope.data.feedWall = new DynamicWall([feedID])
                    }

                }
                $scope.loadGroupFeedWall = function(group) {
                    if (group) {
                        $scope.data.subpage = "groupwall"
                        $scope.data.groupwallid = group.feedID
                        $scope.data.groupWall = group
                        $scope.data.groupWallFeed = new DynamicGroupWall([group])
                    }

                }
                $scope.loadAllGroups = function() {
                    if ("groups" in $scope.data.settings) {

                        $scope.data.groupsWall = new DynamicGroupWall($scope.data.groups)

                    }

                }
                $scope.getProfile = function(feedID) {
                    console.log("get profile", feedID)
                    if (!$scope.data.profiles[feedID]) {
                        $scope.data.profiles[feedID] = {}
                        $scope.feed.getProfile(feedID).then(function(profile) {
                            console.log(profile)
                            $scope.data.profiles[feedID] = profile[0]
                            $scope.getFile(profile[0].profileImage)
                            $scope.$apply()

                        })
                    }
                }
                $scope.queryHandles = function(query) {
                    var deferred = $q.defer();
                    query = query.split(" ").join('').replace("@").replace("#")
                    $scope.feed.search("@" + query).then(function(results) {

                        console.log(results)
                        deferred.resolve(results)
                    })
                    return deferred.promise
                }
                $scope.queryTags = function(query) {
                    var deferred = $q.defer();
                    query = query.split(" ").join('').replace("@", '').replace("#", '')
                    $scope.feed.search("#" + query).then(function(results) {

                        console.log(results)
                        deferred.resolve(results)
                    })
                    return deferred.promise
                }
                $scope.queryPublicPost = function(text) {

                    var re = /(?:^|\W)(@|#)(\w+)(?!\w)/g,
                        match = [];
                    text.slice(Math.max(text.lastIndexOf("@"), text.lastIndexOf("#"), text.lastIndexOf(" ")))
                    if (match = re.exec(text.slice(Math.max(text.lastIndexOf("@"), text.lastIndexOf("#"), text.lastIndexOf(" "))))) {
                        var deferred = $q.defer();

                        if (match.length) {
                            $scope.feed.search(match[0]).then(function(results) {
                                if (results.length) deferred.resolve(results)
                            })
                            return deferred.promise
                        }
                    }
                }
                $scope.submitPublicPost = function(tab) {
                    if (tab.publicPost.text || tab.publicPost.files.length) {
                        var publicPost = {
                            message: tab.publicPost.text,
                            files: tab.publicPost.files,
                            tags: [],
                            mentions: []
                        }
                        var mentions = /(?:^|\W)@(\w+)(?!\w)/g,
                            tags = /(?:^|\W)#(\w+)(?!\w)/g,
                            match = [];
                        while (match = tags.exec(tab.publicPost.text)) {
                            publicPost.tags.push(match[1])
                        }
                        while (match = mentions.exec(tab.publicPost.text)) {
                            publicPost.mentions.push(match[1])
                        }
                        tab.publicPost.text = ""
                        if (!tab.type) {
                            //it's a subpost
                            if (!tab.publicPost.belongsTo) {
                                //first answer
                                publicPost.belongsTo = tab._id
                            } else {
                                publicPost.belongsTo = tab.belongsTo

                            }
                            publicPost.answersTo = tab._id
                            tab.publicPost.text = ""
                            tab.answer = false
                        }
                        $scope.feed.publicPost(publicPost).then(function(answer) {
                            console.log(answer)
                        })
                        if (tab.resetPublicFiles) tab.resetPublicFiles()

                        tab.publicPost.files = []

                    }
                }
                $scope.submitGroupPost = function(group) {
                    if (group.groupPost.text || group.groupPost.files.length) {
                        var groupPost = {
                            message: group.groupPost.text,
                            files: group.groupPost.files,
                        }
                        $scope.feed.groupPost(group, groupPost).then(function(answer) {
                            console.log(answer)
                        })
                        group.resetGroupFiles()
                        group.groupPost.text = ""
                        group.groupPost.files = []
                    }

                }
                $scope.autocompletePublicPost = function(text, result) {
                    return text.slice(0, Math.max(text.lastIndexOf("@"), text.lastIndexOf("#")) + 1) + result
                }
                $scope.getToastPosition = function() {
                    return Object.keys($scope.toastPosition)
                        .filter(function(pos) {
                            return $scope.toastPosition[pos];
                        })
                        .join(' ');
                };
                $scope.showSimpleToast = function(message) {
                    $mdToast.show(
                        $mdToast.simple()
                        .content(message)
                        .position($scope.getToastPosition())
                        .hideDelay(0)
                    );
                };
                $scope.imagePath = "./assets/svg/avatars.svg"
                $scope.next = function() {
                    $scope.data.selectedIndex = Math.min($scope.data.selectedIndex + 1, 2);
                };
                $scope.previous = function() {
                    $scope.data.selectedIndex = Math.max($scope.data.selectedIndex - 1, 0);
                };

                var DynamicWall = function(feedIDs) {
                    console.log("DynamicWall", feedIDs)
                    this.index = []
                    this.PAGE_SIZE = 50;
                    var self = this

                    feedIDs.forEach(function(feedID) {
                        self.addFeedID(feedID)
                    })
                    this.loadedPosts = {}
                    this.loading = {}
                    this.lastReq = {}

                    return this


                }

                DynamicWall.prototype.addFeedID = function(feedID) {
                    var self = this;


                    $scope.getProfile(feedID)
                    $scope.feed.getFeedDocIds(feedID).then(
                        function(ans) {
                            self.index = self.index.concat(ans)
                                // console.log(self.index)
                                // console.log(ans)
                            self.index.sort(function(a, b) {
                                return parseFloat(b.date) - parseFloat(a.date);
                            });
                            // console.log(self.index)
                            // self.getItemAtIndex(0)
                        })
                    $scope.feed.follow(feedID, function(data) {
                        $scope.data.mywallunread++
                            $scope.$apply()
                        self.index = self.index.concat(data)
                        self.index.sort(function(a, b) {
                            return parseFloat(b.date) - parseFloat(a.date);
                        });
                        // console.log(self.index)
                    })
                }
                DynamicWall.prototype.getItemAtIndex = function(index) {
                    // console.log("getItemAtIndex ", index)
                    var self = this
                    var remaining = 0;
                    var lastdate;
                    if (this.index[index]) {


                        var feedID = this.index[index].feedID
                        var page = this.loadedPosts[index];
                        // console.log(feedID)
                        var docid = this.index[index].feedID + this.index[index].feedID
                        this.index.slice(index).filter(function(b) {
                                if (b.feedID == feedID) {
                                    remaining++
                                    lastdate = b.date
                                }
                            })
                            // console.log(remaining, lastdate)
                        if (remaining <= 3 && lastdate != "" && this.lastReq[feedID] != lastdate) {
                            this.lastReq[feedID] = lastdate
                            $scope.feed.getFeedDocIds(feedID, lastdate).then(
                                function(ans) {

                                    self.index = self.index.concat(ans)
                                    self.index.sort(function(a, b) {
                                        return parseFloat(b.date) - parseFloat(a.date);
                                    });
                                })
                        }
                        // console.log(this.loadedPosts[feedID + this.index[index].date])
                        var docid = feedID + this.index[index].date
                        if (docid in this.loadedPosts) {
                            // console.log(this.loadedPosts[feedID + this.index[index].date])
                            return this.loadedPosts[feedID + this.index[index].date];
                        } else if (!this.loading[feedID + this.index[index].date]) {
                            this.loading[feedID + this.index[index].date] = true
                            var docids = []
                            for (var i = 0; i <= 3; i++) {
                                if (this.index[index + i] && this.index[index + i].date) {
                                    if (!this.loadedPosts[this.index[index + i].feedID + this.index[index].date]) {
                                        docids.push(this.index[index + i].feedID + this.index[index + i].date)
                                        this.loading[this.index[index + i].feedID + this.index[index + i].date] = true

                                    }
                                }
                            }
                            // console.log("get", docids)

                            $scope.feed.get(docids).then(function(data) {
                                data.forEach(function(doc, i, theDocs) {
                                        doc.date = doc._id.split("-")[1]
                                        doc.feedID = doc._id.split("-")[0]
                                        theDocs[i] = doc;
                                        self.loadedPosts[doc._id] = doc
                                    })
                                    // console.log(self.loadedPosts)

                            })


                            // $scope.feed.getFeed(feedID, this.index[index].date).then(function(data) {
                            //     console.log(data)
                            //     self.loadedPosts = self.loadedPosts.concat(data)
                            //     self.loadedPosts.sort(function(a, b) {
                            //         if ((a !== null) && (b !== null)) {
                            //             return parseFloat(a.date) - parseFloat(b.date);
                            //         }
                            //     });
                            //     console.log(self.loadedPosts)
                            // })
                        }
                    }



                }
                DynamicWall.prototype.getLength = function() {
                    // console.log("getLength ", 3)
                    return this.index.length + 1
                }

                var DynamicGroupWall = function(groups) {
                    console.log("DynamicGroupWall")

                    this.index = []
                    this.PAGE_SIZE = 50;
                    var self = this

                    this.group = {}

                    groups.forEach(function(group) {
                        self.addGroup(group)
                    })
                    this.loadedPosts = {}
                    this.loading = {}
                    this.lastReq = {}
                    return this


                }

                DynamicGroupWall.prototype.addGroup = function(group) {
                    var self = this;
                    self.group[group.feedID] = group
                    group.data.users.forEach(function(user) {
                        $scope.getProfile(user)
                    })
                    $scope.feed.getFeedDocIds(group.feedID).then(
                        function(ans) {
                            self.index = self.index.concat(ans)
                                // console.log(self.index)
                                // console.log(ans)
                            self.index.sort(function(a, b) {
                                return parseFloat(b.date) - parseFloat(a.date);
                            });
                            // console.log(self.index)
                            // self.getItemAtIndex(0)
                        })
                    $scope.feed.follow(group.feedID, function(data) {
                        console.log(data)
                        $scope.data.groupwallunread++;
                        $scope.$apply()
                        self.index = self.index.concat(data)
                        self.index.sort(function(a, b) {
                            return parseFloat(b.date) - parseFloat(a.date);
                        });
                        // console.log(self.index)
                    })
                }
                DynamicGroupWall.prototype.getItemAtIndex = function(index) {
                    // console.log("getItemAtIndex ", index)
                    var self = this
                    var remaining = 0;
                    var lastdate;
                    // console.log(this.index)
                    if (this.index[index]) {


                        var feedID = this.index[index].feedID
                        var page = this.loadedPosts[index];


                        this.index.slice(index).filter(function(b) {
                                if (b.feedID == feedID) {
                                    remaining++
                                    lastdate = b.date
                                }
                            })
                            // console.log(remaining, lastdate)
                        if (remaining <= 3 && lastdate && this.lastReq[feedID] != lastdate) {
                            this.lastReq[feedID] = lastdate
                            $scope.feed.getFeedDocIds(feedID, lastdate).then(
                                function(ans) {

                                    self.index = self.index.concat(ans)
                                    self.index.sort(function(a, b) {
                                        return parseFloat(b.date) - parseFloat(a.date);
                                    });
                                })
                        }
                        var docid = feedID + this.index[index].date
                        if (docid in this.loadedPosts) {
                            // console.log(this.loadedPosts[feedID + this.index[index].date])
                            return this.loadedPosts[feedID + this.index[index].date];
                        } else if (!this.loading[feedID + this.index[index].date]) {
                            this.loading[feedID + this.index[index].date] = true
                                // var docids = []
                                // for (var i = 0; i <= 3; i++) {
                                //     if (this.index[index + i] && this.index[index + i].date) {
                                //         var docid = this.index[index + i].feedID + this.index[index].date
                                //         if (!(docid in this.loadedPosts)) {
                                //             docids.push(this.index[index + i].feedID + this.index[index + i].date)
                                //             this.loading[this.index[index + i].feedID + this.index[index + i].date] = true

                            //         }
                            //     }
                            // }
                            var docids = [feedID + this.index[index].date]
                            console.log("get", docids)

                            $scope.feed.get(docids).then(function(data) {
                                console.log(data)
                                for (var i in data) {
                                    var doc = data[i]
                                    feedID = doc._id.split("-")[0]
                                    doc = $scope.feed.decryptDoc(doc, self.group[feedID].secret)
                                    var post = JSON.parse(doc.data.doc)
                                    post.date = doc._id.split("-")[1]
                                    post.feedID = feedID
                                    post.user = doc.data.key
                                    post._id = doc._id
                                    self.loadedPosts[doc._id] = post
                                    console.log(post)

                                }
                                console.log(self.loadedPosts, self.index)
                                    // console.log(self.loadedPosts)


                            })


                            // $scope.feed.getFeed(feedID, this.index[index].date).then(function(data) {
                            //     console.log(data)
                            //     self.loadedPosts = self.loadedPosts.concat(data)
                            //     self.loadedPosts.sort(function(a, b) {
                            //         if ((a !== null) && (b !== null)) {
                            //             return parseFloat(a.date) - parseFloat(b.date);
                            //         }
                            //     });
                            //     console.log(self.loadedPosts)
                            // })
                        }
                    }



                }
                DynamicGroupWall.prototype.getLength = function() {
                    // console.log("getLength ", 3)
                    // return this.index.length+1
                    console.log(this.index.length, Object.keys(this.loadedPosts).length)
                    return Object.keys(this.loadedPosts).length
                }

            });
    })();

    function createCookie(name, value, days) {
        if (days) {
            var date = new Date();
            date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
            var expires = "; expires=" + date.toGMTString();
        } else var expires = "";
        document.cookie = name + "=" + value + expires + "; path=/";
    }

    function readCookie(name) {
        var nameEQ = name + "=";
        var ca = document.cookie.split(';');
        for (var i = 0; i < ca.length; i++) {
            var c = ca[i];
            while (c.charAt(0) == ' ') c = c.substring(1, c.length);
            if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
        }
        return null;
    }

    function eraseCookie(name) {
        createCookie(name, "", -1);
    }
    </script>
</body>

</html>
